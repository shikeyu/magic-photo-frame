# 魔法相框 (Magic Photo Frame) 使用说明

[English Version](README_EN.md)

**魔法相框** 是一个基于 Web 的前端应用，旨在连接 ComfyUI 本地服务，将静态照片转化为生动的动态视频，并以“电子相框”的形式进行沉浸式展示。

> **注：本项目的全部代码均由 AI 编程助手 [Trae](https://www.trae.ai) 自动生成。**

---

## 🚀 快速开始

### 1. 准备工作
*   **启动 ComfyUI**：确保您的 ComfyUI 已在本地运行。
    *   **重要**：启动时必须允许跨域访问 (CORS)。请使用以下参数启动：
        ```bash
        python main.py --listen --port 8188 --enable-cors-header
        ```
*   **模型与节点要求**（针对内置默认工作流）：
    *   **必需模型**：
        1.  Checkpoint: `wan2.2-i2v-rapid-aio-v10-nsfw.safetensors`
        2.  CLIP Vision: `clip_vision_h.safetensors`
    *   **必需插件节点**：
        *   ComfyUI-VideoHelperSuite (VHS)
        *   ComfyUI-LayerStyle (LayerUtility)
        *   WanVideo 相关节点 (WanImageToVideo)
*   **打开应用**：在浏览器中打开 `index.html`（建议使用本地服务器运行，如 `python -m http.server`）。

### 2. 连接服务
1.  在页面顶部的 **“ComfyUI 服务地址”** 输入框中填写您的地址（默认 `http://127.0.0.1:8188`）。
2.  点击 **“连接检测”**。若状态显示为绿色的“已连接”，说明连接成功。

### 3. 配置工作流
1.  **导入/导出功能**：
    *   **导入**：点击 **“导入工作流”** (Ctrl+I) 支持 `.json` 或 `.yaml` 格式文件（文件大小限制 ≤10MB）。系统会自动识别并解析内容。
    *   **导出**：点击 **“导出工作流”** (Ctrl+E) 将当前编辑区内容保存为标准 JSON 文件，文件名包含时间戳版本号。
    *   **手动粘贴**：也可以直接在文本框中粘贴 ComfyUI API 格式工作流 (JSON)。
2.  **占位符支持**：应用会自动替换以下内容，无需手动修改 JSON：
    *   `{{IMAGE_FILENAME}}`：上传的图片文件名。
    *   `{{PROMPT}}`：提示词。
    *   `{{VIDEO_SCALE}}`：视频分辨率（长边）。
    *   `seed`：随机种子（自动随机化）。
3.  点击 **“设为默认”** 可保存当前工作流，下次刷新页面自动加载。

### 4. 添加图片
1.  点击 **“添加文件”** 按钮，选择本地图片（支持多选）。
2.  图片会自动进行裁剪检查（建议 3:4 比例），您可以在弹出的裁剪器中调整。
3.  **自定义提示词**：点击图片预览图上的 **“✎”** 按钮，可以为每张图片单独设置提示词（如“让火焰动起来”）。如果不设置，将使用全局默认提示词。
4.   **保存/加载列表**：您可以保存当前的图片列表（包含提示词配置）到本地 JSON 文件，方便下次直接加载。

### 5. 生成与结果管理
*   **手动生成**：点击 **“生成魔法视频”** 按钮，应用会依次处理列表中的图片。
*   **结果预览**：
    *   **卡片式网格**：点击任意图片，右侧（或下方）会以 3:4 纵向网格形式展示所有已生成的视频结果。
    *   **视频信息**：每个卡片底部悬浮显示分辨率与时长。
    *   **删除功能**：点击卡片右上角的 **“✕”** 按钮可删除视频。
        *   **智能防复活**：删除的视频会被加入本地黑名单，即使点击“同步历史”，已删除的视频也不会再次出现。
*   **同步历史 (🔄)**：
    *   点击 **“同步历史”** 按钮，系统会从 ComfyUI 后台拉取历史记录。
    *   **自动去重**：同步前会自动清空当前列表，防止数据重复堆积。

---

## 🖼️ 相框模式 (Photo Frame Mode)

这是本应用的核心功能，将您的屏幕变为一个动态展示的电子相框。

### 进入模式
点击 **“开启相框模式”** 按钮即可进入全屏展示。

### 核心特性
1.  **混合展示**：相框会轮流展示静态照片。如果该照片已生成了视频，则会以无缝过渡的方式播放视频片段。
2.  **后台自动生成**：
    *   在欣赏照片的同时，后台会默默地为没有视频（或视频数量未达上限）的图片生成新视频。
    *   新生成的视频会**立即插队播放**，让您第一时间看到魔法效果。
3.  **多版本轮播**：
    *   系统支持“一对多”模式。一张图片可以对应多个不同的视频变体。
    *   每次轮播到该图时，会随机播放其中一个版本，保持新鲜感。

### 设置选项
在页面底部的 **“相框模式设置”** 面板中，您可以调整：
*   **照片展示时长**：静态图停留的时间。
*   **视频触发概率**：轮播到某张图时，有多大概率播放其对应的视频（建议设为较低值以制造惊喜，或设为 100% 全程动态）。
*   **单图最大视频数**：限制每张图片最多生成几个视频变体（默认 5 个），防止无限占用存储。
*   **自动后台生成**：开关后台生成功能。关闭后仅播放现有视频。
*   **背景音乐**：输入音频 URL，相框模式下自动循环播放。
*   **默认提示词**：配置全局默认的提示词库（每行一个）。当图片未单独设置提示词时，系统会从中随机抽取一条使用。
    *   **推荐示例**：
        ```text
        让图片动起来，画面生动
        video of a vivid scene, high quality
        cinematic lighting, 4k, slow motion
        ```
*   **显示时钟**：在右下角显示当前日期和时间。

### 控制操作
*   **退出**：点击右上角的 **“×”** 按钮，或按键盘 **`Esc`** 键。
*   **手动切换**：点击屏幕任意位置，或按 **`空格` / `→`** 键可立即切换到下一张。
*   **重置状态**：点击设置区的 **“重置视频状态”** 按钮，可清除所有已关联的视频记录，强制重新开始生成。

---

## 🛠️ 常见问题 (FAQ)

**Q: 为什么点击“生成”没反应？**
A: 请检查：1. ComfyUI 是否已连接；2. 工作流 JSON 是否有效；3. 是否已添加至少一张图片。

**Q: 相框模式下为什么一直是静态图，没有视频？**
A: 视频生成需要时间。请耐心等待，或检查控制台日志确认后台生成是否在运行。一旦第一个视频生成完毕，它会自动播放。

**Q: 点击图片后看不到之前的视频？**
A: 请点击 **“🔄 同步历史”** 按钮，系统会从后台找回所有生成的视频记录。

**Q: 删除 output 目录下的视频会怎样？**
A: 播放时会失败，程序会自动跳过并清除该记录。建议使用应用内的删除按钮进行管理。
